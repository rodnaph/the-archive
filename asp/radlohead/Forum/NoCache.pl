###############################################################################################
###############################################################################################
##
##  nocache.pl
##
###############################################################################################
###############################################################################################

use strict;

use LWP::Simple;
use CGI;

###############################################################################################

my $q = new CGI();
my $server = 'www.radiohead.com';

###############################################################################################

print $q->header( -type => 'text/html' );

###############################################################################################
##
##  show a particular post...
##
###############################################################################################

if ( my $number = $q->param('post') ) {

  my $url = "http://$server/Forum/dim.html?ID=$number";
  my $post = get( $url );

  if ( $post ) {

    my $page = get_page();

    # main shtuff
    $post =~ s/http:\/\/$server\/Forum("><f)/\/\/www.radlohead.com\/Forum\/NoCache.pl?page=$page$1/;
    $post = edit( $post );

    # do html bit...
    $post =~ s/\{link\}(.*)\{\/link\}/<a href="$1">$1<\/a>/gi;
    $post =~ s/\{img\}(.*)\{\/img\}/<img src="$1" \/>/gi;

    print $post;

  }
  else {

    print_box('Board Error', "Post $number not found at $url" );

  }

}

###############################################################################################
##
##  else draw the main page...
##
###############################################################################################

else {

  my $page = get_page();
  my $url = "http://$server/Forum/index.html?Page=$page.html";
  my $board = get( $url );

  if ( $board ) {

    $board =~ s/index\.html\?Page=(\d+)/NoCache.pl?page=$1/g;
    $board = edit( $board );

    print $board;

  }
  else {

    print_box('Board Error', "Message Board Page $page not found at $url");

  }

}

###############################################################################################
##
##  edit( text )
##
###############################################################################################

sub edit {

  my ( $text ) = @_;

  my $base = "http://www.radlohead.com/Forum";

  $text =~ s/SubmitMessage\.html/$base\/Post.pl/;
  $text =~ s/dim\.html\?ID=(\d+)/$base\/NoCache.pl?post=$1/g;
  $text =~ s/(ForumStyles\.css)/http:\/\/$server\/Forum\/$1/;

  return $text;

}

###############################################################################################
##
##  get_page()
##
###############################################################################################

sub get_page {

  return ($q->param('page')) ? $q->param('page') : 0;

}

###############################################################################################
###############################################################################################